<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Test educativo avanzado</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:system-ui;background:#f2f4f8;margin:0}
header{background:#2d6cdf;color:#fff;padding:15px;text-align:center}
.container{max-width:750px;margin:auto;background:#fff;min-height:100vh;padding:20px}
button{width:100%;padding:14px;margin:8px 0;font-size:16px;border:none;border-radius:8px;background:#2d6cdf;color:white}
.secondary{background:#aaa;color:black}
.option{background:#eef1f6;padding:14px;border-radius:8px;margin:10px 0;cursor:pointer}
.option.correct{background:#c8f7c5;border:2px solid #2ecc71}
.option.incorrect{background:#f7c5c5;border:2px solid #e74c3c}
.option.disabled{pointer-events:none}
.hidden{display:none}
.progress{text-align:center;margin-bottom:10px}
.review{background:#f9fafc;padding:12px;border-radius:8px;margin-bottom:10px}
.ok{color:#2ecc71;font-weight:bold}
.ko{color:#e74c3c;font-weight:bold}
.timer{font-weight:bold;text-align:center;margin-bottom:10px}
</style>
</head>

<body>
<header>
<h2>Plataforma de test</h2>
</header>

<div class="container">

<div id="menu">
<button onclick="startTest('comunidades_aprendizaje')">Comunidades de aprendizaje</button>
<button onclick="startTest('dificultades_aprendizaje')">Dificultades de aprendizaje</button>
<button onclick="startTest('tic_aprendizaje_conectado')">TIC y aprendizaje conectado</button>
<button onclick="startTest('familia_sistema_dinamico')">Familia sistema din√°mico</button>
<button onclick="startTest('organizacion_escolar')">Organizaci√≥n escolar</button>
<button onclick="startTest('apego_y_desarrollo_socioemocional')">Apego y desarrollo socioemocional</button>

<label><input type="checkbox" id="modoExamen"> Modo examen</label>
</div>

<div id="test" class="hidden">
<div class="timer" id="timer"></div>
<div class="progress" id="progress"></div>
<div id="questionBox"></div>
<button class="secondary" onclick="prev()">Anterior</button>
<button onclick="next()">Siguiente</button>
<button id="finishBtn" class="hidden" onclick="finish()">Finalizar</button>
</div>

<div id="review" class="hidden"></div>

</div>

<script>
let banco={}, preguntas=[], index=0, respuestas=[], temaActual="";
let tiempo=600, reloj=null, modoExamen=false;

fetch("preguntas.json").then(r=>r.json()).then(d=>banco=d);

function startTest(tema){
  temaActual=tema;
  modoExamen=document.getElementById("modoExamen").checked;
  preguntas=shuffle([...banco[tema]]).slice(0,10);
  respuestas=[];
  index=0;
  tiempo=600;
  guardarStats(tema,"intentos");
  document.getElementById("menu").classList.add("hidden");
  document.getElementById("test").classList.remove("hidden");
  iniciarTimer();
  render();
}

function iniciarTimer(){
  reloj=setInterval(()=>{
    tiempo--;
    document.getElementById("timer").innerText="‚è± Tiempo: "+tiempo+"s";
    if(tiempo<=0) finish();
  },1000);
}

function render(){
  const p=preguntas[index];
  document.getElementById("progress").innerText=`Pregunta ${index+1} de 10`;
  let opciones=shuffle(p.a.map((t,i)=>({t,i})));
  let html=`<h3>${p.q}</h3>`;
  opciones.forEach(o=>{
    html+=`<div class="option" onclick="answer(${o.i})" id="opt${o.i}">${o.t}</div>`;
  });
  document.getElementById("questionBox").innerHTML=html;
  document.getElementById("finishBtn").classList.toggle("hidden",index<9);
}

function answer(sel){
  if(respuestas[index]!=null) return;
  respuestas[index]=sel;
  if(modoExamen) return;
  marcar();
}

function marcar(){
  const correct=preguntas[index].c;
  preguntas[index].a.forEach((_,i)=>{
    const el=document.getElementById("opt"+i);
    if(!el) return;
    el.classList.add("disabled");
    if(i===correct) el.classList.add("correct");
    if(i===respuestas[index] && i!==correct) el.classList.add("incorrect");
  });
}

function next(){if(index<9){index++;render();}}
function prev(){if(index>0){index--;render();}}

function finish(){
  clearInterval(reloj);
  document.getElementById("test").classList.add("hidden");
  const r=document.getElementById("review");
  r.innerHTML="<h3>Resultados</h3>";
  let aciertos=0;
  preguntas.forEach((p,i)=>{
    const ok=respuestas[i]===p.c;
    if(ok) aciertos++; else guardarStats(temaActual,"fallos");
    r.innerHTML+=`
    <div class="review">
      <span class="${ok?"ok":"ko"}">${ok?"‚úî Correcta":"‚úò Incorrecta"}</span><br>
      ${p.q}<br>
      ${!ok?`üìÑ Repasar en: <em>${p.ref||"PDF del tema"}</em>`:""}
    </div>`;
  });
  guardarStats(temaActual,"aciertos",aciertos);
  r.classList.remove("hidden");
}

function guardarStats(tema,tipo,valor=1){
  let stats=JSON.parse(localStorage.getItem("stats"))||{};
  if(!stats[tema]) stats[tema]={intentos:0,aciertos:0,fallos:0};
  stats[tema][tipo]+=valor;
  localStorage.setItem("stats",JSON.stringify(stats));
}

function shuffle(a){return a.sort(()=>Math.random()-0.5);}
</script>
</body>
</html>
