<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spots de Surf cerca de Valencia</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f9ff;
      margin: 0;
      padding: 2rem;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #0077b6;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 2rem;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ccc;
      padding: 1rem;
      text-align: left;
    }

    th {
      background-color: #0077b6;
      color: white;
    }

    a {
      color: #0077b6;
      text-decoration: none;
      font-weight: bold;
    }

    a:hover {
      text-decoration: underline;
    }

    #popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #popupContent {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      width: 300px;
      text-align: center;
    }

    input, button {
      padding: 0.6rem;
      width: 100%;
      margin-top: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    label {
      margin-top: 1rem;
      display: block;
      font-weight: bold;
    }

    .controls {
      margin-top: 1rem;
      text-align: center;
    }

    .controls input[type=range] {
      width: 50%;
    }
  </style>
</head>
<body>
  <div id="popup">
    <div id="popupContent">
      <h3>Introduce tu API Key de Stormglass</h3>
      <input type="password" id="apiKeyInput" placeholder="tu-api-key"/>
      <button onclick="saveApiKey()">Guardar</button>
    </div>
  </div>

  <h1>Spots de Surf cerca de Valencia</h1>

  <div class="controls">
    <label for="distance">Distancia máx. desde tu ubicación (km): <span id="distVal">100</span></label>
    <input type="range" id="distance" min="10" max="200" value="100" oninput="document.getElementById('distVal').textContent = this.value"/>
  </div>

  <table id="spotsTable">
    <thead>
      <tr>
        <th>Spot</th>
        <th>Altura de Olas</th>
        <th>Viento</th>
        <th>Comentarios</th>
      </tr>
    </thead>
    <tbody>
      <!-- Los datos se insertarán aquí dinámicamente -->
    </tbody>
  </table>

  <script>
    const spots = [
      { name: "Malvarrosa Beach", lat: 39.4789, lon: -0.3306 },
      { name: "Playa de Levante", lat: 39.4702, lon: -0.3768 },
      { name: "El Saler", lat: 39.3958, lon: -0.3194 },
      { name: "Playa de las Arenas", lat: 39.4655, lon: -0.3302 },
      { name: "Cullera/Júcar", lat: 39.1667, lon: -0.2500 },
      { name: "Sagunto", lat: 39.6800, lon: -0.2667 },
      { name: "Platja de Xeraco", lat: 39.0333, lon: -0.2000 },
      { name: "El Perelló", lat: 39.2833, lon: -0.2833 }
    ];

    function saveApiKey() {
      const key = document.getElementById("apiKeyInput").value.trim();
      if (key) {
        localStorage.setItem("stormglass_api_key", key);
        document.getElementById("popup").style.display = "none";
        getLocation();
      } else {
        alert("Introduce una API key válida.");
      }
    }

    window.onload = () => {
      const savedKey = localStorage.getItem("stormglass_api_key");
      if (!savedKey) {
        document.getElementById("popup").style.display = "flex";
      } else {
        document.getElementById("popup").style.display = "none";
        getLocation();
      }
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            fetchSpotData(lat, lon);
          },
          err => {
            alert("No se pudo obtener tu ubicación.");
            console.error(err);
          }
        );
      } else {
        alert("Tu navegador no soporta geolocalización.");
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        0.5 - Math.cos(dLat)/2 + 
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        (1 - Math.cos(dLon))/2;

      return R * 2 * Math.asin(Math.sqrt(a));
    }

    async function fetchSpotData(userLat, userLon) {
      const apiKey = localStorage.getItem("stormglass_api_key");
      const distanceLimit = parseInt(document.getElementById("distance").value);
      const now = new Date();
      const isoDate = now.toISOString();

      const tableBody = document.querySelector("#spotsTable tbody");
      tableBody.innerHTML = "";

      for (const spot of spots) {
        const distance = calculateDistance(userLat, userLon, spot.lat, spot.lon);
        if (distance <= distanceLimit) {
          try {
            const response = await fetch(`https://api.stormglass.io/v2/weather/point?lat=${spot.lat}&lng=${spot.lon}&params=waveHeight,windSpeed,windDirection&source=sg`, {
              headers: {
                'Authorization': apiKey
              }
            });
            const data = await response.json();
            const waveHeight = data.hours[0].waveHeight.sg;
            const windSpeed = data.hours[0].windSpeed.sg;
            const windDirection = data.hours[0].windDirection.sg;

            const row = document.createElement("tr");
            row.innerHTML = `
              <td><a href="https://www.google.com/maps?q=${encodeURIComponent(spot.name + ', Valencia')}" target="_blank">${spot.name}</a></td>
              <td>${waveHeight ? waveHeight.toFixed(2) + " m" : "N/A"}</td>
              <td>${windSpeed ? windSpeed.toFixed(1) + " km/h" : "N/A"} ${windDirection ? getCardinalDirection(windDirection) : ""}</td>
              <td>${generateComment(waveHeight, windSpeed)}</td>
            `;
            tableBody.appendChild(row);
          } catch (error) {
            console.error(`Error al obtener datos para ${spot.name}:`, error);
          }
        }
      }
    }

    function getCardinalDirection(angle) {
      const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
      return directions[Math.round(angle / 45) % 8];
    }

    function generateComment(waveHeight, windSpeed) {
      if (!waveHeight || !windSpeed) return "Datos no disponibles.";
      if (waveHeight < 0.3) return "Olas pequeñas; ideal para principiantes.";
      if (waveHeight < 1.0) return "Condiciones moderadas; adecuado para intermedios.";
      return "Olas grandes; recomendado para surfistas experimentados.";
    }

    document.getElementById("distance").addEventListener("change", () => {
      getLocation();
    });
  </script>
</body>
</html>