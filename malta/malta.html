<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mdina & Rabat â€“ Monumentos y NarraciÃ³n</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; }
  #map { height: 55vh; }
  .panel { padding: 12px; }
  .poi { border-bottom: 1px solid #ddd; padding: 10px 0; }
  .badge { display:inline-block; padding:2px 6px; border:1px solid #999; border-radius:4px; font-size:12px; margin-right:4px;}
  .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }
  .muted { color:#666; }
  details summary { cursor: pointer; font-weight: bold; margin-top: 6px; }
  button { cursor:pointer; }
</style>
</head>
<body>
  <div class="panel">
    <h1>Mdina & Rabat â€“ Monumentos, Historia y Curiosidades</h1>
    <p class="muted">Explora los lugares mÃ¡s icÃ³nicos de Mdina y Rabat y escucha su historia como si estuvieras en un free tour.</p>
    <div class="controls">
      <label>Radio (km): <input type="number" id="radiusKm" value="3" step="0.5" min="0.5" max="10"></label>
      <button id="btnUseGeo">Usar mi geolocalizaciÃ³n</button>
      <button id="btnShowAll">Mostrar todo</button>
      <button id="btnNarrarHistoria">ğŸ™ï¸ Narrar historia general</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div id="map"></div>
  <div class="panel">
    <h2>Monumentos principales</h2>
    <div id="list"></div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
// Monumentos principales con historia y curiosidades ampliadas
const pois = [
  {
    "id":"mdina_gate",
    "name":"Mdina Gate (Puerta Principal)",
    "city":"Mdina",
    "category":"Monumento",
    "lat":35.8869,"lng":14.4034,
    "summary":"Entrada barroca icÃ³nica a la Ciudad Silenciosa.",
    "history":"La Mdina Gate, construida en 1724 bajo el Gran Maestre de Vilhena, es un sÃ­mbolo barroco que reemplazÃ³ una entrada medieval mÃ¡s simple. Su diseÃ±o monumental no solo servÃ­a como defensa, sino como carta de presentaciÃ³n de la nobleza maltesa y de la ciudad fortificada. Desde aquÃ­ se accede a un mundo donde el tiempo parece detenido. \
Durante siglos, esta puerta ha visto entrar y salir caballeros, nobles, comerciantes y peregrinos. Hoy es una de las postales mÃ¡s reconocibles de Malta y un recordatorio del poder histÃ³rico que tuvo Mdina como capital de la isla.",
    "facts":"Fue escenario de Game of Thrones como la entrada de Desembarco del Rey. Sus muros muestran aÃºn marcas de balas y reparaciones antiguas. Al cruzarla, se siente un silencio mÃ¡gico que da nombre a la ciudad.",
    "tips":"Cruza la puerta temprano en la maÃ±ana para disfrutarla sin multitudes.",
    "opening_hours":"Exterior siempre visible.",
    "est_time_min":10,"ticket_eur":0
  },
  {
    "id":"st_pauls_cathedral_mdina",
    "name":"Catedral de San Pablo (Mdina)",
    "city":"Mdina",
    "category":"Iglesia/Museo",
    "lat":35.8862,"lng":14.4039,
    "summary":"Templo barroco con museo anexo.",
    "history":"La Catedral de San Pablo se levanta sobre el lugar donde, segÃºn la tradiciÃ³n, el gobernador Publio recibiÃ³ al apÃ³stol Pablo tras su naufragio en Malta en el aÃ±o 60 d.C. El terremoto de 1693 destruyÃ³ la antigua iglesia, y el arquitecto Lorenzo GafÃ  diseÃ±Ã³ la actual, una joya barroca que combina grandeza y espiritualidad. \
El interior sorprende con frescos, mÃ¡rmoles policromados y obras de Mattia Preti. El museo anexo conserva tesoros de los Caballeros de la Orden de Malta y documentos papales que narran siglos de fe y poder.",
    "facts":"Su campanario domina el horizonte de Mdina. En sus criptas descansan obispos y nobles malteses. Alberga uno de los archivos mÃ¡s antiguos de Malta.",
    "tips":"Compra entrada combinada con el museo para aprovechar mejor la visita.",
    "opening_hours":"Luâ€“Sa 09:30â€“16:30; Dom restringido.",
    "est_time_min":40,"ticket_eur":15
  },
  {
    "id":"st_pauls_catacombs",
    "name":"Catacumbas de San Pablo",
    "city":"Rabat",
    "category":"Sitio arqueolÃ³gico",
    "lat":35.8816,"lng":14.3983,
    "summary":"Extenso complejo de catacumbas paleocristianas.",
    "history":"Las Catacumbas de San Pablo son el mayor testimonio de la comunidad cristiana primitiva en Malta. Se usaron desde el siglo IV como cementerio subterrÃ¡neo, con pasajes y cÃ¡maras donde se enterraban familias enteras. Las mesas de banquetes funerarios muestran que no solo eran tumbas, sino tambiÃ©n lugares de memoria y celebraciÃ³n. \
La frescura de las paredes aÃºn guarda inscripciones y sÃ­mbolos paleocristianos, que nos hablan de un tiempo en el que la fe se vivÃ­a bajo tierra para protegerla.",
    "facts":"Las mesas circulares de piedra son Ãºnicas en el MediterrÃ¡neo. Algunas paredes conservan trazos de pintura original.",
    "tips":"Lleva calzado cÃ³modo y una linterna por si quieres explorar los rincones mÃ¡s oscuros.",
    "opening_hours":"09:00â€“17:00 (Ãºltima entrada 16:30).",
    "est_time_min":40,"ticket_eur":6
  },
  {
    "id":"domus_romana",
    "name":"Domus Romana",
    "city":"Rabat",
    "category":"Museo/Sitio arqueolÃ³gico",
    "lat":35.8869,"lng":14.401,
    "summary":"Restos de villa romana con mosaicos destacados.",
    "history":"La Domus Romana fue descubierta en 1881 durante trabajos en Rabat y revelÃ³ una villa de Ã©poca romana del siglo I a.C. Sus mosaicos son de los mÃ¡s antiguos del MediterrÃ¡neo, comparables a los de Pompeya y Herculano. La casa pertenecÃ­a probablemente a una familia adinerada, testimonio del nivel cultural y artÃ­stico de la isla bajo el dominio de Roma. \
El museo conserva tambiÃ©n objetos cotidianos hallados en el lugar: monedas, estatuillas y cerÃ¡micas que nos transportan a la vida privada de hace dos mil aÃ±os.",
    "facts":"El mosaico central representa a dos palomas bebiendo de una copa, sÃ­mbolo de belleza clÃ¡sica. Es uno de los mosaicos mejor preservados fuera de Italia.",
    "tips":"Combina la visita con Mdina Gate, estÃ¡ muy cerca.",
    "opening_hours":"Horario de museo (varÃ­a por temporada).",
    "est_time_min":20,"ticket_eur":6
  },
  {
    "id":"st_pauls_grotto",
    "name":"Gruta de San Pablo",
    "city":"Rabat",
    "category":"Santuario",
    "lat":35.8818,"lng":14.399,
    "summary":"Cueva asociada a San Pablo tras el naufragio en Malta.",
    "history":"SegÃºn la tradiciÃ³n, tras el naufragio de San Pablo en Malta, el apÃ³stol se refugiÃ³ en esta gruta y comenzÃ³ a predicar, iniciando la conversiÃ³n de los malteses al cristianismo. Durante siglos fue lugar de peregrinaciÃ³n y oraciÃ³n, visitado por papas, santos y reyes. La gruta conserva imÃ¡genes, exvotos y sÃ­mbolos dejados por fieles a lo largo de los siglos. \
Juan Pablo II y el papa Benedicto XVI rezaron aquÃ­, reforzando su carÃ¡cter de santuario universal.",
    "facts":"Se conserva un busto de San Pablo donado por el rey Felipe V de EspaÃ±a en el siglo XVIII.",
    "tips":"Ideal para visitar junto a las catacumbas cercanas.",
    "opening_hours":"SegÃºn parroquia.",
    "est_time_min":15,"ticket_eur":0
  }
];

// NarraciÃ³n general estilo free tour
const historiaGeneral = `Mdina, la Ciudad del Silencio, fue la antigua capital de Malta durante siglos. Su historia comienza hace mÃ¡s de 3.000 aÃ±os con los fenicios, pasÃ³ por romanos, Ã¡rabes y caballeros de la Orden. Hoy conserva su aire noble y tranquilo, con apenas 300 habitantes. 
Rabat, su vecina, era el barrio popular y extenso, donde se encuentran las catacumbas y la gruta de San Pablo, lugares clave del cristianismo en Malta. Mientras Mdina es elegancia silenciosa, Rabat late con mercados, cafÃ©s y vida cotidiana.`;

const DEFAULT_CENTER = [35.8865, 14.4035]; // Mdina
const DEFAULT_ZOOM = 15;
let map = L.map('map').setView(DEFAULT_CENTER, DEFAULT_ZOOM);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let userMarker = null;
let radiusCircle = null;
let markers = [];

function haversineKm(a, b) {
  const toRad = d => d * Math.PI / 180;
  const R = 6371;
  const dLat = toRad(b[0]-a[0]);
  const dLon = toRad(b[1]-a[1]);
  const lat1 = toRad(a[0]);
  const lat2 = toRad(b[0]);
  const sinDLat = Math.sin(dLat/2);
  const sinDLon = Math.sin(dLon/2);
  const c = 2 * Math.asin(Math.sqrt(sinDLat*sinDLat + Math.cos(lat1)*Math.cos(lat2)*sinDLon*sinDLon));
  return R * c;
}

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  if (radiusCircle) map.removeLayer(radiusCircle);
  radiusCircle = null;
}

function narrarTexto(texto) {
  const utter = new SpeechSynthesisUtterance(texto);
  utter.lang = "es-ES";
  utter.rate = 1;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

function renderPOI(poi) {
  const popup = `
    <strong>${poi.name}</strong><br>
    <span class="badge">${poi.city}</span> Â· <span class="badge">${poi.category}</span><br>
    ${poi.summary}<br><em>${poi.history.substring(0,100)}...</em>
    <br><button onclick="narrarTexto('${poi.name}. ${poi.history.replace(/'/g,"")}')">ğŸ™ï¸ Escuchar</button>
  `;
  const m = L.marker([poi.lat, poi.lng]).bindPopup(popup);
  m.addTo(map);
  markers.push(m);
}

function renderList(list) {
  const container = document.getElementById('list');
  container.innerHTML = '';
  list.forEach(poi => {
    const div = document.createElement('div');
    div.className = 'poi';
    div.innerHTML = `
      <strong>${poi.name}</strong> <span class="badge">${poi.city}</span> Â· <span class="badge">${poi.category}</span><br>
      ${poi.summary}<br>
      <details><summary>Historia</summary><p>${poi.history}</p></details>
      <details><summary>Curiosidades</summary><p>${poi.facts}</p></details>
      <em>Tiempo:</em> ${poi.est_time_min} min Â· <em>Entrada:</em> â‚¬${poi.ticket_eur} Â· <small>${poi.opening_hours}</small><br>
      <a href="https://www.google.com/maps?q=${poi.lat},${poi.lng}" target="_blank" rel="noopener">Abrir en Google Maps</a><br>
      <button onclick="narrarTexto('${poi.name}. ${poi.history.replace(/'/g,"")}')">ğŸ™ï¸ Escuchar narraciÃ³n</button>
    `;
    container.appendChild(div);
  });
}

function showAll() {
  clearMarkers();
  pois.forEach(renderPOI);
  renderList(pois);
  if (pois.length) {
    map.fitBounds(L.latLngBounds(pois.map(p => [p.lat, p.lng])), { padding: [20,20] });
  }
  document.getElementById('status').textContent = `Mostrando ${pois.length} lugares`;
}

function filterByRadius(center, km) {
  clearMarkers();
  const within = pois.filter(p => haversineKm(center, [p.lat, p.lng]) <= km);
  within.forEach(renderPOI);
  renderList(within);
  if (within.length) {
    map.fitBounds(L.latLngBounds(within.map(p => [p.lat, p.lng]).concat([center])), { padding: [20,20] });
  } else {
    map.setView(center, DEFAULT_ZOOM);
  }
  radiusCircle = L.circle(center, { radius: km*1000 }).addTo(map);
  document.getElementById('status').textContent = `En un radio de ${km} km: ${within.length} lugares`;
}

function setUserLocation(lat, lng) {
  const pos = [lat, lng];
  if (userMarker) map.removeLayer(userMarker);
  userMarker = L.marker(pos).addTo(map).bindPopup('Tu ubicaciÃ³n');
  const km = parseFloat(document.getElementById('radiusKm').value)||3;
  filterByRadius(pos, km);
}

document.getElementById('btnUseGeo').addEventListener('click', () => {
  if (!navigator.geolocation) {
    document.getElementById('status').textContent = 'GeolocalizaciÃ³n no soportada.';
    return;
  }
  document.getElementById('status').textContent = 'Obteniendo ubicaciÃ³n...';
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const { latitude, longitude } = pos.coords;
      setUserLocation(latitude, longitude);
      document.getElementById('status').textContent = 'UbicaciÃ³n establecida.';
    },
    () => {
      document.getElementById('status').textContent = 'No se pudo obtener tu ubicaciÃ³n. Mostrando todo.';
      showAll();
    },
    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
  );
});

document.getElementById('btnShowAll').addEventListener('click', showAll);
document.getElementById('radiusKm').addEventListener('change', () => {
  if (userMarker) {
    const pos = userMarker.getLatLng();
    filterByRadius([pos.lat, pos.lng], parseFloat(document.getElementById('radiusKm').value)||3);
  }
});
document.getElementById('btnNarrarHistoria').addEventListener('click', () => narrarTexto(historiaGeneral));

// Mostrar todo al inicio
showAll();
</script>
</body>
</html>